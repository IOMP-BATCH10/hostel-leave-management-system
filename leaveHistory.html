<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Leave History</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Segoe UI", Arial, sans-serif; background: #f5f7fa; min-height: 100vh; }

        .topbar {
            background: #1f4ed8;
            color: white;
            padding: 16px 32px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .topbar h1 { font-size: 20px; font-weight: 600; }
        .topbar-right { display: flex; align-items: center; gap: 16px; }
        .topbar-right span { font-size: 13px; opacity: 0.85; }
        .back-btn {
            color: white;
            text-decoration: none;
            background: rgba(255,255,255,0.15);
            padding: 6px 14px;
            border-radius: 5px;
            font-size: 13px;
        }
        .back-btn:hover { background: rgba(255,255,255,0.25); }

        .container { max-width: 1000px; margin: 32px auto; padding: 0 20px; }

        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 28px;
        }
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 18px 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            text-align: center;
            border-top: 3px solid transparent;
        }
        .stat-card.total    { border-top-color: #6366f1; }
        .stat-card.pending  { border-top-color: #f59e0b; }
        .stat-card.approved { border-top-color: #10b981; }
        .stat-card.rejected { border-top-color: #ef4444; }
        .stat-card .num { font-size: 28px; font-weight: 700; }
        .stat-card.total    .num { color: #6366f1; }
        .stat-card.pending  .num { color: #f59e0b; }
        .stat-card.approved .num { color: #10b981; }
        .stat-card.rejected .num { color: #ef4444; }
        .stat-card .lbl { font-size: 12px; color: #6b7280; margin-top: 4px; }

        /* Top actions */
        .top-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px;
            flex-wrap: wrap;
            gap: 12px;
        }
        .filter-row { display: flex; gap: 10px; flex-wrap: wrap; }
        .filter-row select {
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            background: white;
        }
        .filter-row select:focus { outline: none; border-color: #2563eb; }
        .btn-new {
            padding: 9px 20px;
            background: #1f4ed8;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            text-decoration: none;
            display: inline-block;
        }
        .btn-new:hover { background: #173db3; }

        /* Table card */
        .table-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.07);
            overflow: hidden;
        }
        .table-header {
            padding: 18px 24px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .table-header h2 { font-size: 16px; color: #1f2937; font-weight: 600; }
        .total-badge {
            background: #eff6ff;
            color: #2563eb;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 500;
        }

        table { width: 100%; border-collapse: collapse; }
        thead th {
            background: #f9fafb;
            padding: 12px 16px;
            text-align: left;
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid #e5e7eb;
        }
        tbody td {
            padding: 14px 16px;
            font-size: 14px;
            color: #374151;
            border-bottom: 1px solid #f3f4f6;
            vertical-align: top;
        }
        tbody tr:last-child td { border-bottom: none; }
        tbody tr:hover { background: #f9fafb; }

        /* Badges */
        .badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .badge-pending           { background: #fef3c7; color: #92400e; }
        .badge-caretaker-approved{ background: #dbeafe; color: #1e40af; }
        .badge-approved          { background: #d1fae5; color: #065f46; }
        .badge-rejected          { background: #fee2e2; color: #991b1b; }

        /* Progress tracker */
        .progress-track {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-top: 8px;
        }
        .step { display: flex; align-items: center; gap: 4px; }
        .dot { width: 10px; height: 10px; border-radius: 50%; background: #d1d5db; flex-shrink: 0; }
        .dot.done   { background: #10b981; }
        .dot.active { background: #f59e0b; }
        .dot.failed { background: #ef4444; }
        .step-label { font-size: 10px; color: #9ca3af; }
        .step-label.done   { color: #065f46; }
        .step-label.active { color: #92400e; }
        .step-label.failed { color: #991b1b; }
        .connector { width: 18px; height: 2px; background: #d1d5db; }
        .connector.done { background: #10b981; }

        .comment-box {
            margin-top: 6px;
            font-size: 12px;
            color: #6b7280;
            font-style: italic;
        }
        .comment-box span { font-weight: 600; font-style: normal; color: #374151; }

        .empty-state { text-align: center; padding: 70px 20px; color: #9ca3af; }
        .empty-state .icon { font-size: 52px; margin-bottom: 14px; }
        .empty-state p { font-size: 15px; margin-bottom: 16px; }
        .loading { text-align: center; padding: 40px; color: #6b7280; }

        @media (max-width: 700px) {
            .stats-grid { grid-template-columns: repeat(2, 1fr); }
            .topbar { flex-direction: column; gap: 10px; text-align: center; }
        }
    </style>
</head>
<body>

<div class="topbar">
    <h1>üìÑ My Leave History</h1>
    <div class="topbar-right">
        <span id="studentNameLabel"></span>
        <a href="studentDashboard.html" class="back-btn">‚Üê Dashboard</a>
    </div>
</div>

<div class="container">

    <!-- Stats -->
    <div class="stats-grid">
        <div class="stat-card total">
            <div class="num" id="statTotal">‚Äî</div>
            <div class="lbl">Total Applied</div>
        </div>
        <div class="stat-card pending">
            <div class="num" id="statPending">‚Äî</div>
            <div class="lbl">In Progress</div>
        </div>
        <div class="stat-card approved">
            <div class="num" id="statApproved">‚Äî</div>
            <div class="lbl">Approved</div>
        </div>
        <div class="stat-card rejected">
            <div class="num" id="statRejected">‚Äî</div>
            <div class="lbl">Rejected</div>
        </div>
    </div>

    <!-- Filter + New Request -->
    <div class="top-actions">
        <div class="filter-row">
            <select id="statusFilter" onchange="applyFilter()">
                <option value="">All Statuses</option>
                <option value="Pending">Pending</option>
                <option value="Caretaker Approved">Caretaker Approved</option>
                <option value="Approved">Approved</option>
                <option value="Rejected">Rejected</option>
            </select>
        </div>
        <a href="leaveReqForm.html" class="btn-new">+ New Leave Request</a>
    </div>

    <!-- Table -->
    <div class="table-card">
        <div class="table-header">
            <h2>All My Requests</h2>
            <span class="total-badge" id="totalBadge">0 records</span>
        </div>
        <div id="tableContainer">
            <div class="loading">Loading your leave history...</div>
        </div>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="config.js"></script>
<script src="supabaseClient.js"></script>
<script>
    let student = null;
    let allRequests = [];

    window.onload = async function () {
        const stored = sessionStorage.getItem("loggedInUser");
        if (!stored) {
            alert("You must be logged in.");
            window.location.href = "loginStudent.html";
            return;
        }

        student = JSON.parse(stored);
        document.getElementById("studentNameLabel").textContent =
            `üë§ ${student.full_name} | ${student.hostel_type}`;

        await loadHistory();
    };

    async function loadHistory() {
        const { data, error } = await supabaseClient
            .from("leave_requests")
            .select("*")
            .eq("student_id", student.id)
            .order("applied_at", { ascending: false });

        if (error) { console.error(error); return; }
        allRequests = data || [];

        // Update stats
        document.getElementById("statTotal").textContent    = allRequests.length;
        document.getElementById("statPending").textContent  = allRequests.filter(r =>
            r.status === 'Pending' || r.status === 'Caretaker Approved').length;
        document.getElementById("statApproved").textContent = allRequests.filter(r =>
            r.status === 'Approved').length;
        document.getElementById("statRejected").textContent = allRequests.filter(r =>
            r.status === 'Rejected').length;

        applyFilter();
    }

    function applyFilter() {
        const statusVal = document.getElementById("statusFilter").value;
        const filtered  = statusVal
            ? allRequests.filter(r => r.status === statusVal)
            : allRequests;

        document.getElementById("totalBadge").textContent =
            `${filtered.length} record${filtered.length !== 1 ? 's' : ''}`;
        renderTable(filtered);
    }

    function renderTable(data) {
        const container = document.getElementById("tableContainer");

        if (data.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="icon">üì≠</div>
                    <p>No leave requests found.</p>
                    <a href="leaveReqForm.html" class="btn-new">Apply for Leave</a>
                </div>`;
            return;
        }

        container.innerHTML = `
            <table>
                <thead>
                    <tr>
                        <th>#</th>
                        <th>From</th>
                        <th>To</th>
                        <th>Block / Room</th>
                        <th>Reason</th>
                        <th>Applied On</th>
                        <th>Status & Progress</th>
                        <th>Comments</th>
                    </tr>
                </thead>
                <tbody>
                    ${data.map((r, i) => `
                        <tr>
                            <td style="color:#9ca3af;font-size:13px;">${i + 1}</td>
                            <td>${formatDate(r.from_date)}</td>
                            <td>${formatDate(r.to_date)}</td>
                            <td>${r.block || '‚Äî'} / ${r.room_number || '‚Äî'}</td>
                            <td title="${r.reason}">${truncate(r.reason, 30)}</td>
                            <td>${formatDate(r.applied_at)}</td>
                            <td>
                                <span class="badge ${badgeClass(r.status)}">${r.status}</span>
                                ${progressTracker(r.status)}
                            </td>
                            <td>${commentsCell(r)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            </table>`;
    }

    // Visual 3-step progress tracker: Submitted ‚Üí Caretaker ‚Üí Warden
    function progressTracker(status) {
        let s1 = 'done', l1 = 'done';          // Submitted always done
        let s2 = '', l2 = '';                   // Caretaker step
        let conn1 = '', conn2 = '';
        let s3 = '', l3 = '';                   // Warden step

        if (status === 'Pending') {
            s2 = 'active'; l2 = 'active';
            conn1 = '';
        } else if (status === 'Caretaker Approved') {
            s2 = 'done'; l2 = 'done'; conn1 = 'done';
            s3 = 'active'; l3 = 'active';
        } else if (status === 'Approved') {
            s2 = 'done'; l2 = 'done'; conn1 = 'done';
            s3 = 'done'; l3 = 'done'; conn2 = 'done';
        } else if (status === 'Rejected') {
            s2 = 'failed'; l2 = 'failed'; conn1 = '';
            s3 = ''; l3 = '';
        }

        return `
            <div class="progress-track">
                <div class="step">
                    <div class="dot ${s1}"></div>
                    <span class="step-label ${l1}">Submitted</span>
                </div>
                <div class="connector ${conn1}"></div>
                <div class="step">
                    <div class="dot ${s2}"></div>
                    <span class="step-label ${l2}">Caretaker</span>
                </div>
                <div class="connector ${conn2}"></div>
                <div class="step">
                    <div class="dot ${s3}"></div>
                    <span class="step-label ${l3}">Warden</span>
                </div>
            </div>`;
    }

    function commentsCell(r) {
        const lines = [];
        if (r.caretaker_comment) {
            lines.push(`<div class="comment-box"><span>Caretaker:</span> ${r.caretaker_comment}</div>`);
        }
        if (r.warden_comment) {
            lines.push(`<div class="comment-box"><span>Warden:</span> ${r.warden_comment}</div>`);
        }
        return lines.length ? lines.join('') : '<span style="color:#9ca3af;font-size:12px;">‚Äî</span>';
    }

    function badgeClass(s) {
        if (s === 'Pending')            return 'badge-pending';
        if (s === 'Caretaker Approved') return 'badge-caretaker-approved';
        if (s === 'Approved')           return 'badge-approved';
        if (s === 'Rejected')           return 'badge-rejected';
        return '';
    }
    function formatDate(d) { return d ? new Date(d).toLocaleDateString('en-IN') : '‚Äî'; }
    function truncate(str, n) { return str && str.length > n ? str.slice(0, n) + '...' : (str || '‚Äî'); }
</script>

</body>
</html>